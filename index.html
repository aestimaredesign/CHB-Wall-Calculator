<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional CHB Wall Estimation Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #c0392b;
            --gray: #95a5a6;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 20px;
        }
        
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        
        header {
            grid-column: 1 / -1;
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        h2 {
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
        }
        
        h3 {
            color: var(--dark);
            margin: 15px 0 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
        }
        
        .checkbox-group input {
            width: auto;
            margin-right: 10px;
        }
        
        .btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            display: inline-block;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn-block {
            display: block;
            width: 100%;
            text-align: center;
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-success:hover {
            background: #219955;
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-danger:hover {
            background: #a33226;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--light);
            font-weight: 600;
        }
        
        tr:hover {
            background-color: rgba(236, 240, 241, 0.5);
        }
        
        .cost-summary {
            background: var(--light);
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
        
        .cost-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .cost-total {
            font-weight: 600;
            font-size: 1.2em;
            border-top: 2px solid var(--dark);
            padding-top: 10px;
            margin-top: 10px;
        }
        
        .visualization {
            background: white;
            border-radius: 8px;
            padding: 20px;
            height: 500px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        canvas {
            border: 1px solid #ddd;
            background: #f9f9f9;
            max-width: 100%;
            max-height: 100%;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: var(--secondary);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .alert {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .alert-warning {
            background: rgba(243, 156, 18, 0.2);
            border-left: 4px solid var(--warning);
        }
        
        .alert-danger {
            background: rgba(192, 57, 43, 0.2);
            border-left: 4px solid var(--danger);
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted var(--gray);
            cursor: help;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--dark);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            font-weight: normal;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input {
            flex: 1;
        }
        
        .section {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .subsection {
            padding-left: 15px;
            border-left: 3px solid var(--light);
            margin: 15px 0;
        }
        
        .material-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .badge-primary {
            background: var(--secondary);
            color: white;
        }
        
        .badge-success {
            background: var(--success);
            color: white;
        }
        
        .badge-warning {
            background: var(--warning);
            color: white;
        }
        
        .factor-slider {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .factor-slider input[type="range"] {
            flex: 1;
        }
        
        .factor-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
        }
        
        .boq-table td:last-child, 
        .boq-table th:last-child {
            text-align: right;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .input-error {
            border-color: var(--danger);
            box-shadow: 0 0 0 2px rgba(192, 57, 43, 0.2);
        }
        
        .error-text {
            color: var(--danger);
            font-size: 14px;
            margin-top: 5px;
        }
        
        .visualization-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .visualization-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border: 1px solid #ccc;
        }
        
        .help-section {
            margin-top: 20px;
            padding: 15px;
            background: var(--light);
            border-radius: 4px;
        }
        
        .help-section details {
            margin-bottom: 10px;
        }
        
        .help-section summary {
            font-weight: 600;
            cursor: pointer;
        }
        
        .help-section p {
            margin-top: 10px;
        }
        
        .qs-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .qs-table th, .qs-table td {
            padding: 10px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }
        
        .qs-table th:first-child, .qs-table td:first-child {
            text-align: left;
        }
        
        .qs-table th {
            background-color: var(--light);
        }
        
        .qs-table .total-row {
            font-weight: bold;
            border-top: 2px solid var(--dark);
        }
        
        .productivity-library {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
        
        .productivity-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .rebar-options {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
        
        .plaster-options {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
        
        .project-info {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .formula-box {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid var(--secondary);
            margin: 10px 0;
        }
        
        .formula-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--primary);
        }
        
        .formula {
            font-family: monospace;
            background: #f5f5f5;
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
            display: block;
        }
        
        .adjustment-factor {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ddd;
        }
        
        .factor-name {
            font-weight: bold;
            color: var(--primary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Professional CHB Wall Estimation Calculator</h1>
            <p>Compliant with NSCP, ACI, ASTM, and Eurocode standards</p>
        </header>
        
        <div class="left-column">
            <div class="project-info">
                <h2>Project Information</h2>
                <div class="form-group">
                    <label for="projectName">Project Name</label>
                    <input type="text" id="projectName" value="Residential Boundary Wall">
                </div>
                <div class="form-group">
                    <label for="clientName">Client Name</label>
                    <input type="text" id="clientName" value="John Dela Cruz">
                </div>
                <div class="form-group">
                    <label for="projectLocation">Project Location</label>
                    <input type="text" id="projectLocation" value="Manila, Philippines">
                </div>
                <div class="form-group">
                    <label for="companyName">Company</label>
                    <input type="text" id="companyName" value="ABC Construction Inc.">
                </div>
                <div class="form-group">
                    <label for="preparedBy">Prepared By</label>
                    <input type="text" id="preparedBy" value="Maria Santos, Civil Engineer">
                </div>
            </div>
            
            <div class="card">
                <div class="tabs">
                    <div class="tab active" data-tab="dimensions">Dimensions</div>
                    <div class="tab" data-tab="materials">Materials</div>
                    <div class="tab" data-tab="labor">Labor & Costs</div>
                    <div class="tab" data-tab="factors">Adjustment Factors</div>
                    <div class="tab" data-tab="help">Help & Formulas</div>
                </div>
                
                <form id="calculatorForm">
                    <!-- Tab content will be added in the next batch -->
                </form>
            </div>
            
            <div class="card">
                <h2>Calculation Results</h2>
                <div id="results">
                    <p class="alert alert-warning">Enter wall dimensions and click Calculate to see results</p>
                </div>
            </div>
        </div>
        
        <div class="right-column">
            <div class="card">
                <h2>Wall Visualization</h2>
                <div class="visualization-controls">
                    <button class="btn" id="zoomIn">Zoom In</button>
                    <button class="btn" id="zoomOut">Zoom Out</button>
                    <button class="btn" id="resetView">Reset View</button>
                </div>
                <div class="visualization">
                    <canvas id="wallCanvas" width="600" height="400"></canvas>
                </div>
                <div class="visualization-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f9f9f9;"></div>
                        <span>CHB Blocks</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: rgba(200, 200, 255, 0.5);"></div>
                        <span>Openings</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: red;"></div>
                        <span>Rebar</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>Bill of Quantities</h2>
                <div id="boq">
                    <p class="alert alert-warning">Calculation required to generate BOQ</p>
                </div>
                <div class="export-buttons">
                    <button class="btn" id="exportPDF">Export PDF</button>
                    <button type="button" class="btn btn-danger" id="resetBtn">Reset</button>
                </div>
            </div>
        </div>
    </div>
                        <!-- Tab content for Dimensions -->
                    <div class="tab-content active" id="dimensions-tab">
                        <div class="form-group">
                            <label for="wallLength">Wall Length (m)</label>
                            <input type="number" id="wallLength" step="0.01" min="0.1" value="10" required>
                            <div class="error-text" id="wallLengthError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="wallHeight">Wall Height (m)</label>
                            <input type="number" id="wallHeight" step="0.01" min="0.1" value="3" required>
                            <div class="error-text" id="wallHeightError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="chbSize">CHB Size</label>
                            <select id="chbSize">
                                <option value="0.1">4" (100mm) thick</option>
                                <option value="0.15" selected>6" (150mm) thick</option>
                                <option value="0.2">8" (200mm) thick</option>
                            </select>
                        </div>
                        
                        <h3>Openings</h3>
                        
                        <div class="form-group">
                            <label for="doorCount">Number of Doors</label>
                            <input type="number" id="doorCount" min="0" value="1">
                            <div class="error-text" id="doorCountError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="doorWidth">Average Door Width (m)</label>
                            <input type="number" id="doorWidth" step="0.01" min="0.5" value="0.9">
                            <div class="error-text" id="doorWidthError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="doorHeight">Average Door Height (m)</label>
                            <input type="number" id="doorHeight" step="0.01" min="1.5" value="2.1">
                            <div class="error-text" id="doorHeightError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="windowCount">Number of Windows</label>
                            <input type="number" id="windowCount" min="0" value="2">
                            <div class="error-text" id="windowCountError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="windowWidth">Average Window Width (m)</label>
                            <input type="number" id="windowWidth" step="0.01" min="0.3" value="1.2">
                            <div class="error-text" id="windowWidthError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="windowHeight">Average Window Height (m)</label>
                            <input type="number" id="windowHeight" step="0.01" min="0.3" value="1.2">
                            <div class="error-text" id="windowHeightError"></div>
                        </div>
                    </div>
                    
                    <!-- Tab content for Materials -->
                    <div class="tab-content" id="materials-tab">
                        <div class="form-group">
                            <label for="standard">Design Standard <span class="tooltip">ℹ️
                                <span class="tooltiptext">Select the building code standard for reinforcement and plaster specifications</span>
                            </span></label>
                            <select id="standard">
                                <option value="nscp">NSCP (Philippines)</option>
                                <option value="aci">ACI (American)</option>
                                <option value="astm">ASTM</option>
                                <option value="eurocode">Eurocode</option>
                            </select>
                        </div>
                        
                        <h3>Reinforcement</h3>
                        <div class="rebar-options">
                            <div class="form-group">
                                <label for="rebarVertSpacing">Vertical Bar Spacing (mm) <span class="tooltip">ℹ️
                                    <span class="tooltiptext">Distance between vertical reinforcing bars</span>
                                </span></label>
                                <input type="number" id="rebarVertSpacing" value="800" min="400" step="100">
                            </div>
                            <div class="form-group">
                                <label for="rebarHorizSpacing">Horizontal Bar Layers <span class="tooltip">ℹ️
                                    <span class="tooltiptext">Number of CHB courses between horizontal bars (typically every 3rd course)</span>
                                </span></label>
                                <input type="number" id="rebarHorizSpacing" value="3" min="1" step="1">
                            </div>
                            <div class="form-group">
                                <label for="rebarDiameter">Rebar Diameter (mm)</label>
                                <select id="rebarDiameter">
                                    <option value="10">10mm</option>
                                    <option value="12" selected>12mm</option>
                                    <option value="16">16mm</option>
                                </select>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="includeLaps" checked>
                                <label for="includeLaps">Include lap splices and hooks</label>
                            </div>
                            <div class="form-group">
                                <label for="lapLength">Lap Length (mm) <span class="tooltip">ℹ️
                                    <span class="tooltiptext">Based on rebar diameter and code requirements</span>
                                </span></label>
                                <input type="number" id="lapLength" value="480" min="300" step="10">
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="cornerBars">
                                <label for="cornerBars">Include corner bars</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="lintelBars">
                                <label for="lintelBars">Include lintel reinforcement</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="dowelBars">
                                <label for="dowelBars">Include dowel bars</label>
                            </div>
                        </div>
                        
                        <h3>Mortar & Plaster</h3>
                        <div class="form-group">
                            <label for="mortarRatio">Mortar Mix Ratio <span class="tooltip">ℹ️
                                <span class="tooltiptext">Cement to sand ratio for mortar</span>
                            </span></label>
                            <select id="mortarRatio">
                                <option value="1:3">1:3 (Rich mix)</option>
                                <option value="1:4" selected>1:4 (Standard)</option>
                                <option value="1:5">1:5 (Economy)</option>
                                <option value="1:6">1:6 (Lean mix)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cementFactor">Cement Factor (bags/m³) <span class="tooltip">ℹ️
                                <span class="tooltiptext">Varies by standard and mix ratio</span>
                            </span></label>
                            <input type="number" id="cementFactor" step="0.1" min="7" max="12" value="9">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="plastering" checked>
                            <label for="plastering">Include plastering</label>
                        </div>
                        <div class="plaster-options">
                            <div class="form-group">
                                <label for="plasterSides">Plaster Sides</label>
                                <select id="plasterSides">
                                    <option value="1">One Side Only</option>
                                    <option value="2" selected>Both Sides</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="plasterRatio">Plaster Mix Ratio <span class="tooltip">ℹ️
                                    <span class="tooltiptext">Cement to sand ratio for plaster</span>
                                </span></label>
                                <select id="plasterRatio">
                                    <option value="1:2">1:2 (Rich mix)</option>
                                    <option value="1:3" selected>1:3 (Standard)</option>
                                    <option value="1:4">1:4 (Economy)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="plasterCementFactor">Plaster Cement Factor (bags/m³) <span class="tooltip">ℹ️
                                    <span class="tooltiptext">Varies by standard and mix ratio</span>
                                </span></label>
                                <input type="number" id="plasterCementFactor" step="0.1" min="10" max="16" value="12">
                            </div>
                            <div class="form-group">
                                <label for="plasterThickness">Plaster Thickness (mm) <span class="tooltip">ℹ️
                                    <span class="tooltiptext">Thickness of plaster on each side</span>
                                </span></label>
                                <input type="number" id="plasterThickness" value="20" min="10" max="30" step="5">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab content for Labor -->
                    <div class="tab-content" id="labor-tab">
                        <div class="form-group">
                            <label for="productivityRate">Productivity Rate (m²/day) <span class="tooltip">ℹ️
                                <span class="tooltiptext">Area of CHB wall a mason can complete in one day</span>
                            </span></label>
                            <select id="productivityRate">
                                <option value="4">4 m²/day (Complex work)</option>
                                <option value="6">6 m²/day (High quality)</option>
                                <option value="8" selected>8 m²/day (Standard quality)</option>
                                <option value="10">10 m²/day (Economy)</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="form-group" id="customRateContainer" style="display: none;">
                            <label for="customRate">Custom Rate (m²/day)</label>
                            <input type="number" id="customRate" min="4" max="15" step="0.5" value="8">
                        </div>
                        <div class="productivity-library">
                            <h4>Productivity Adjustment Factors</h4>
                            <div class="productivity-item">
                                <span>Wall Complexity:</span>
                                <select id="complexityFactor">
                                    <option value="1.0">Simple (straight walls)</option>
                                    <option value="0.9" selected>Moderate (some corners)</option>
                                    <option value="0.8">Complex (many corners/angles)</option>
                                </select>
                            </div>
                            <div class="productivity-item">
                                <span>Scaffolding Required:</span>
                                <select id="scaffoldingFactor">
                                    <option value="1.0">None (low height)</option>
                                    <option value="0.95" selected>Moderate (medium height)</option>
                                    <option value="0.9">Extensive (high walls)</option>
                                </select>
                            </div>
                            <div class="productivity-item">
                                <span>Opening Complexity:</span>
                                <select id="openingFactor">
                                    <option value="1.0">Few openings</option>
                                    <option value="0.95" selected>Moderate openings</option>
                                    <option value="0.9">Many openings</option>
                                </select>
                            </div>
                        </div>
                        <h3>Crew Composition</h3>
                        <div class="form-group">
                            <label for="masons">Masons</label>
                            <input type="number" id="masons" min="1" value="2">
                        </div>
                        <div class="form-group">
                            <label for="helpers">Helpers</label>
                            <input type="number" id="helpers" min="0" value="2">
                        </div>
                        <div class="form-group">
                            <label for="carpenters">Carpenters (for forms)</label>
                            <input type="number" id="carpenters" min="0" value="1">
                        </div>
                        <h3>Costs</h3>
                        <div class="form-group">
                            <label for="chbCost">CHB Cost per Piece</label>
                            <input type="number" id="chbCost" step="0.01" min="0" value="25">
                        </div>
                        <div class="form-group">
                            <label for="cementCost">Cement Cost per Bag (40kg)</label>
                            <input type="number" id="cementCost" step="0.01" min="0" value="250">
                        </div>
                        <div class="form-group">
                            <label for="sandCost">Sand Cost per m³</label>
                            <input type="number" id="sandCost" step="0.01" min="0" value="800">
                        </div>
                        <div class="form-group">
                            <label for="rebarCost">Rebar Cost per kg</label>
                            <input type="number" id="rebarCost" step="0.01" min="0" value="45">
                        </div>
                        <div class="form-group">
                            <label for="masonDailyRate">Mason Daily Rate</label>
                            <input type="number" id="masonDailyRate" step="0.01" min="0" value="600">
                        </div>
                        <div class="form-group">
                            <label for="helperDailyRate">Helper Daily Rate</label>
                            <input type="number" id="helperDailyRate" step="0.01" min="0" value="400">
                        </div>
                        <div class="form-group">
                            <label for="carpenterDailyRate">Carpenter Daily Rate</label>
                            <input type="number" id="carpenterDailyRate" step="0.01" min="0" value="500">
                        </div>
                    </div>
                    
                    <!-- Tab content for Adjustment Factors -->
                    <div class="tab-content" id="factors-tab">
                        <div class="form-group">
                            <label for="wasteFactor">Waste Factor (%)</label>
                            <div class="factor-slider">
                                <input type="range" id="wasteFactorSlider" min="0" max="20" value="5">
                                <span class="factor-value" id="wasteFactorValue">5%</span>
                            </div>
                            <input type="hidden" id="wasteFactor" value="5">
                        </div>
                        <div class="form-group">
                            <label for="weatherFactor">Weather Conditions <span class="tooltip">ℹ️
                                <span class="tooltiptext">Adjusts productivity based on weather conditions</span>
                            </span></label>
                            <div class="factor-slider">
                                <input type="range" id="weatherFactorSlider" min="80" max="120" value="100">
                                <span class="factor-value" id="weatherFactorValue">100%</span>
                            </div>
                            <input type="hidden" id="weatherFactor" value="100">
                        </div>
                        <div class="form-group">
                            <label for="crewSkill">Crew Skill Level <span class="tooltip">ℹ️
                                <span class="tooltiptext">Adjusts productivity based on crew experience</span>
                            </span></label>
                            <div class="factor-slider">
                                <input type="range" id="crewSkillSlider" min="70" max="130" value="100">
                                <span class="factor-value" id="crewSkillValue">100%</span>
                            </div>
                            <input type="hidden" id="crewSkill" value="100">
                        </div>
                        <div class="form-group">
                            <label for="siteAccess">Site Access Difficulty <span class="tooltip">ℹ️
                                <span class="tooltiptext">Adjusts productivity based on site conditions</span>
                            </span></label>
                            <div class="factor-slider">
                                <input type="range" id="siteAccessSlider" min="80" max="120" value="100">
                                <span class="factor-value" id="siteAccessValue">100%</span>
                            </div>
                            <input type="hidden" id="siteAccess" value="100">
                        </div>
                        <div class="form-group">
                            <label for="overhead">Overhead (%)</label>
                            <div class="factor-slider">
                                <input type="range" id="overheadSlider" min="0" max="30" value="15">
                                <span class="factor-value" id="overheadValue">15%</span>
                            </div>
                            <input type="hidden" id="overhead" value="15">
                        </div>
                        <div class="form-group">
                            <label for="profitMargin">Profit Margin (%)</label>
                            <div class="factor-slider">
                                <input type="range" id="profitMarginSlider" min="0" max="30" value="10">
                                <span class="factor-value" id="profitMarginValue">10%</span>
                            </div>
                            <input type="hidden" id="profitMargin" value="10">
                        </div>
                    </div>
                    
                    <!-- Tab content for Help -->
                    <div class="tab-content" id="help-tab">
                        <div class="help-section">
                            <h3>Adjustment Factors Explained</h3>
                            <div class="adjustment-factor">
                                <div class="factor-name">Waste Factor</div>
                                <p>Accounts for material loss during construction due to cutting, breakage, or other inefficiencies. Typical values range from 5-10%.</p>
                            </div>
                            <div class="adjustment-factor">
                                <div class="factor-name">Weather Conditions</div>
                                <p>Adjusts productivity based on weather impact. Rainy conditions may reduce productivity by 20%, while ideal conditions may increase it by 10%.</p>
                            </div>
                            <div class="adjustment-factor">
                                <div class="factor-name">Crew Skill Level</div>
                                <p>Accounts for the experience and efficiency of the construction crew. Highly skilled crews can be 30% more productive than inexperienced ones.</p>
                            </div>
                            <div class="adjustment-factor">
                                <div class="factor-name">Site Access Difficulty</div>
                                <p>Considers how easy or difficult it is to access the construction site. Limited access can reduce productivity by up to 20%.</p>
                            </div>
                            <div class="adjustment-factor">
                                <div class="factor-name">Overhead</div>
                                <p>Covers indirect costs like supervision, tools, equipment, and administrative expenses. Typically ranges from 10-20% of direct costs.</p>
                            </div>
                            <div class="adjustment-factor">
                                <div class="factor-name">Profit Margin</div>
                                <p>The contractor's profit added to the project cost. Typically ranges from 10-20% of the total cost.</p>
                            </div>
                            <h3>Calculation Formulas</h3>
                            <div class="formula-box">
                                <div class="formula-title">Wall Area Calculation</div>
                                <span class="formula">Net Wall Area = (Length × Height) - (Door Area + Window Area)</span>
                                <p>Where Door Area = Number of Doors × Door Width × Door Height</p>
                                <p>Window Area = Number of Windows × Window Width × Window Height</p>
                            </div>
                            <div class="formula-box">
                                <div class="formula-title">CHB Quantity Calculation</div>
                                <span class="formula">CHB Quantity = Ceiling(Net Wall Area / 0.08)</span>
                                <p>Standard CHB size is 0.4m × 0.2m = 0.08m² per piece</p>
                            </div>
                            <div class="formula-box">
                                <div class="formula-title">Mortar Calculation</div>
                                <span class="formula">Mortar Volume = Net Wall Area × CHB Thickness × 0.25</span>
                                <p>25% of wall volume is estimated to be mortar for joints</p>
                            </div>
                            <div class="formula-box">
                                <div class="formula-title">Cement Calculation</div>
                                <span class="formula">Cement Bags = Mortar Volume × (Cement Part / Total Parts) × Cement Factor</span>
                                <p>Cement factor varies by mix ratio (typically 9-12 bags per m³)</p>
                            </div>
                            <div class="formula-box">
                                <div class="formula-title">Sand Calculation</div>
                                <span class="formula">Sand Volume = Mortar Volume × (Sand Part / Total Parts)</span>
                                <p>For 1:4 mix ratio, sand part is 4 of 5 total parts</p>
                            </div>
                            <div class="formula-box">
                                <div class="formula-title">Rebar Calculation</div>
                                <span class="formula">Vertical Bars = Ceiling(Length / Vertical Spacing) + 1</span>
                                <span class="formula">Horizontal Bars = Ceiling(Height / (0.2 × Horizontal Layers))</span>
                                <p>Standard CHB height is 0.2m per course</p>
                            </div>
                            <div class="formula-box">
                                <div class="formula-title">Labor Calculation</div>
                                <span class="formula">Labor Days = Net Wall Area / (Productivity Rate × Weather Factor × Crew Skill × Site Access)</span>
                                <p>Adjusted for various productivity factors</p>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" id="calculateBtn" class="btn btn-block">Calculate Estimate</button>
                </form>
            </div>
            
            <div class="card">
                <h2>Calculation Results</h2>
                <div id="results">
                    <p class="alert alert-warning">Enter wall dimensions and click Calculate to see results</p>
                </div>
            </div>
        </div>
        
        <div class="right-column">
            <div class="card">
                <h2>Wall Visualization</h2>
                <div class="visualization-controls">
                    <button class="btn" id="zoomIn">Zoom In</button>
                    <button class="btn" id="zoomOut">Zoom Out</button>
                    <button class="btn" id="resetView">Reset View</button>
                </div>
                <div class="visualization">
                    <canvas id="wallCanvas" width="600" height="400"></canvas>
                </div>
                <div class="visualization-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f9f9f9;"></div>
                        <span>CHB Blocks</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: rgba(200, 200, 255, 0.5);"></div>
                        <span>Openings</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: red;"></div>
                        <span>Rebar</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>Bill of Quantities</h2>
                <div id="boq">
                    <p class="alert alert-warning">Calculation required to generate BOQ</p>
                </div>
                <div class="export-buttons">
                    <button class="btn" id="exportPDF">Export PDF</button>
                    <button type="button" class="btn btn-danger" id="resetBtn">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        
        // Global variables
        let zoomLevel = 1;
        let canvas, ctx;

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize canvas
            canvas = document.getElementById('wallCanvas');
            ctx = canvas.getContext('2d');
            
            // Set canvas size based on container
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Tab functionality
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(tabId + '-tab').classList.add('active');
                });
            });
            
            // Custom productivity rate toggle
            const productivityRate = document.getElementById('productivityRate');
            const customRateContainer = document.getElementById('customRateContainer');
            productivityRate.addEventListener('change', function() {
                customRateContainer.style.display = this.value === 'custom' ? 'block' : 'none';
            });
            
            // Update lap length based on rebar diameter and standard
            const rebarDiameter = document.getElementById('rebarDiameter');
            const lapLength = document.getElementById('lapLength');
            const standard = document.getElementById('standard');
            function updateLapLength() {
                const diameter = parseInt(rebarDiameter.value);
                const selectedStandard = standard.value;
                let lapMultiplier = 40;
                if (selectedStandard === 'aci') lapMultiplier = 42;
                if (selectedStandard === 'eurocode') lapMultiplier = 45;
                if (selectedStandard === 'astm') lapMultiplier = 40;
                lapLength.value = diameter * lapMultiplier;
            }
            rebarDiameter.addEventListener('change', updateLapLength);
            standard.addEventListener('change', updateLapLength);
            
            // Update cement factors based on standard and mix ratio
            const mortarRatio = document.getElementById('mortarRatio');
            const cementFactor = document.getElementById('cementFactor');
            const plasterRatio = document.getElementById('plasterRatio');
            const plasterCementFactor = document.getElementById('plasterCementFactor');
            function updateCementFactors() {
                const selectedStandard = standard.value;
                const mortarMix = mortarRatio.value;
                const plasterMix = plasterRatio.value;
                let mortarCementValue = 9;
                let plasterCementValue = 12;
                if (mortarMix === '1:3') mortarCementValue = 10.5;
                if (mortarMix === '1:5') mortarCementValue = 8;
                if (mortarMix === '1:6') mortarCementValue = 7;
                if (plasterMix === '1:2') plasterCementValue = 14;
                if (plasterMix === '1:4') plasterCementValue = 10;
                if (selectedStandard === 'aci') {
                    mortarCementValue *= 1.05;
                    plasterCementValue *= 1.05;
                } else if (selectedStandard === 'eurocode') {
                    mortarCementValue *= 0.95;
                    plasterCementValue *= 0.95;
                }
                cementFactor.value = mortarCementValue.toFixed(1);
                plasterCementFactor.value = plasterCementValue.toFixed(1);
            }
            mortarRatio.addEventListener('change', updateCementFactors);
            plasterRatio.addEventListener('change', updateCementFactors);
            standard.addEventListener('change', updateCementFactors);
            
            // Setup adjustment factor sliders
            setupSlider('wasteFactorSlider', 'wasteFactorValue', 'wasteFactor', '%');
            setupSlider('weatherFactorSlider', 'weatherFactorValue', 'weatherFactor', '%');
            setupSlider('crewSkillSlider', 'crewSkillValue', 'crewSkill', '%');
            setupSlider('siteAccessSlider', 'siteAccessValue', 'siteAccess', '%');
            setupSlider('overheadSlider', 'overheadValue', 'overhead', '%');
            setupSlider('profitMarginSlider', 'profitMarginValue', 'profitMargin', '%');
            
            function setupSlider(sliderId, valueId, hiddenId, suffix = '') {
                const slider = document.getElementById(sliderId);
                const valueDisplay = document.getElementById(valueId);
                const hiddenInput = document.getElementById(hiddenId);
                slider.addEventListener('input', function() {
                    valueDisplay.textContent = this.value + suffix;
                    hiddenInput.value = this.value;
                });
            }
            
            // Calculate button event
            document.getElementById('calculateBtn').addEventListener('click', function() {
                if (validateForm()) {
                    calculateEstimate();
                }
            });
            
            // Export PDF button
            document.getElementById('exportPDF').addEventListener('click', downloadPDF);
            
            // Reset button event
            document.getElementById('resetBtn').addEventListener('click', function() {
                document.querySelectorAll('input, select').forEach(input => {
                    if (input.type === 'number') {
                        input.value = input.hasAttribute('value') ? input.getAttribute('value') : (input.min || 0);
                    } else if (input.type === 'text') {
                        input.value = input.hasAttribute('value') ? input.getAttribute('value') : '';
                    } else if (input.tagName === 'SELECT') {
                        input.value = input.querySelector('option[selected]') ? input.querySelector('option[selected]').value : input.options[0].value;
                    }
                });
                document.querySelectorAll('input[type="hidden"]').forEach(hidden => {
                    const sliderId = hidden.id.replace('Factor', 'Slider');
                    const slider = document.getElementById(sliderId);
                    if (slider) {
                        hidden.value = slider.value;
                        document.getElementById(hidden.id.replace('Factor', 'Value')).textContent = slider.value + '%';
                    }
                });
                document.getElementById('results').innerHTML = '<p class="alert alert-warning">Enter wall dimensions and click Calculate to see results</p>';
                document.getElementById('boq').innerHTML = '<p class="alert alert-warning">Calculation required to generate BOQ</p>';
                drawWallVisualization();
            });
            
            // Visualization controls
            document.getElementById('zoomIn').addEventListener('click', function() {
                zoomLevel *= 1.2;
                drawWallVisualization();
            });
            document.getElementById('zoomOut').addEventListener('click', function() {
                zoomLevel /= 1.2;
                drawWallVisualization();
            });
            document.getElementById('resetView').addEventListener('click', function() {
                zoomLevel = 1;
                drawWallVisualization();
            });
            
            // Input validation on change
            const inputsToValidate = ['wallLength', 'wallHeight', 'doorCount', 'doorWidth', 'doorHeight', 'windowCount', 'windowWidth', 'windowHeight'];
            inputsToValidate.forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    validateField(this.id);
                });
            });
            
            // Initial updates
            updateLapLength();
            updateCementFactors();
            drawWallVisualization();
        });
        
        function resizeCanvas() {
            const container = document.querySelector('.visualization');
            if (container && canvas) {
                canvas.width = container.clientWidth - 40;
                canvas.height = container.clientHeight - 40;
                drawWallVisualization();
            }
        }
        
        function validateForm() {
            let isValid = true;
            isValid &= validateField('wallLength');
            isValid &= validateField('wallHeight');
            isValid &= validateField('doorCount');
            isValid &= validateField('doorWidth');
            isValid &= validateField('doorHeight');
            isValid &= validateField('windowCount');
            isValid &= validateField('windowWidth');
            isValid &= validateField('windowHeight');
            const wallLength = parseFloat(document.getElementById('wallLength').value);
            const wallHeight = parseFloat(document.getElementById('wallHeight').value);
            const doorWidth = parseFloat(document.getElementById('doorWidth').value);
            const doorHeight = parseFloat(document.getElementById('doorHeight').value);
            const windowWidth = parseFloat(document.getElementById('windowWidth').value);
            const windowHeight = parseFloat(document.getElementById('windowHeight').value);
            if (doorWidth > wallLength) {
                document.getElementById('doorWidthError').textContent = 'Door width exceeds wall length';
                document.getElementById('doorWidth').classList.add('input-error');
                isValid = false;
            }
            if (doorHeight > wallHeight) {
                document.getElementById('doorHeightError').textContent = 'Door height exceeds wall height';
                document.getElementById('doorHeight').classList.add('input-error');
                isValid = false;
            }
            if (windowWidth > wallLength) {
                document.getElementById('windowWidthError').textContent = 'Window width exceeds wall length';
                document.getElementById('windowWidth').classList.add('input-error');
                isValid = false;
            }
            if (windowHeight > wallHeight) {
                document.getElementById('windowHeightError').textContent = 'Window height exceeds wall height';
                document.getElementById('windowHeight').classList.add('input-error');
                isValid = false;
            }
            return isValid;
        }
        
        function validateField(fieldId) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');
            let isValid = true;
            let errorMessage = '';
            field.classList.remove('input-error');
            if (field.value === '' || field.value === null) {
                errorMessage = 'This field is required';
                isValid = false;
            } else if (parseFloat(field.value) <= 0 && field.type === 'number') {
                errorMessage = 'Value must be greater than 0';
                isValid = false;
            } else if (parseFloat(field.value) < parseFloat(field.min) && field.hasAttribute('min')) {
                errorMessage = `Value must be at least ${field.min}`;
                isValid = false;
            } else if (parseFloat(field.value) > parseFloat(field.max) && field.hasAttribute('max')) {
                errorMessage = `Value must be at most ${field.max}`;
                isValid = false;
            }
            errorElement.textContent = errorMessage;
            if (!isValid) field.classList.add('input-error');
            return isValid;
        }
    </script>
        <script>
        // [Continued from Batch 2]

        function calculateEstimate() {
            const wallLength = parseFloat(document.getElementById('wallLength').value);
            const wallHeight = parseFloat(document.getElementById('wallHeight').value);
            const chbSize = parseFloat(document.getElementById('chbSize').value);
            const doorCount = parseInt(document.getElementById('doorCount').value);
            const doorWidth = parseFloat(document.getElementById('doorWidth').value);
            const doorHeight = parseFloat(document.getElementById('doorHeight').value);
            const windowCount = parseInt(document.getElementById('windowCount').value);
            const windowWidth = parseFloat(document.getElementById('windowWidth').value);
            const windowHeight = parseFloat(document.getElementById('windowHeight').value);
            
            const grossWallArea = wallLength * wallHeight;
            const doorArea = doorCount * doorWidth * doorHeight;
            const windowArea = windowCount * windowWidth * windowHeight;
            const netWallArea = grossWallArea - doorArea - windowArea;
            
            if (netWallArea <= 0) {
                document.getElementById('results').innerHTML = `
                    <div class="alert alert-danger">
                        Error: Total opening area exceeds wall area. Please check your dimensions.
                    </div>
                `;
                return;
            }
            
            const chbArea = 0.4 * 0.2;
            const chbQuantity = Math.ceil(netWallArea / chbArea);
            const mortarVolume = netWallArea * chbSize * 0.25;
            const cementFactor = parseFloat(document.getElementById('cementFactor').value);
            const mortarRatio = document.getElementById('mortarRatio').value;
            const [cementPart, sandPart] = mortarRatio.split(':').map(Number);
            const totalParts = cementPart + sandPart;
            const cementBagsMortar = Math.ceil(mortarVolume * (cementPart / totalParts) * cementFactor);
            const sandMortar = mortarVolume * (sandPart / totalParts);
            
            const verticalSpacing = parseFloat(document.getElementById('rebarVertSpacing').value) / 1000;
            const horizontalLayers = parseInt(document.getElementById('rebarHorizSpacing').value);
            const rebarDiameter = parseInt(document.getElementById('rebarDiameter').value);
            const lapLengthVal = parseFloat(document.getElementById('lapLength').value) / 1000;
            const verticalBarsCount = Math.ceil(wallLength / verticalSpacing) + 1;
            const verticalRebarLength = verticalBarsCount * (wallHeight + lapLengthVal);
            const chbLayers = Math.ceil(wallHeight / 0.2);
            const horizontalBarsCount = Math.ceil(chbLayers / horizontalLayers);
            const horizontalRebarLength = horizontalBarsCount * (wallLength + lapLengthVal);
            let additionalRebarLength = 0;
            const includeCornerBars = document.getElementById('cornerBars').checked;
            const includeLintelBars = document.getElementById('lintelBars').checked;
            const includeDowelBars = document.getElementById('dowelBars').checked;
            if (includeCornerBars) additionalRebarLength += 4 * 2;
            if (includeLintelBars) additionalRebarLength += doorCount * (doorWidth + 1) + windowCount * (windowWidth + 1);
            if (includeDowelBars) additionalRebarLength += verticalBarsCount * 0.5;
            const includeLaps = document.getElementById('includeLaps').checked;
            const lapFactor = includeLaps ? 1.1 : 1.0;
            const totalRebarLength = (verticalRebarLength + horizontalRebarLength + additionalRebarLength) * lapFactor;
            const rebarWeight = Math.ceil((rebarDiameter * rebarDiameter / 162) * totalRebarLength);
            
            let plasterCementBags = 0, plasterSand = 0;
            const includePlaster = document.getElementById('plastering').checked;
            const plasterSides = parseInt(document.getElementById('plasterSides').value);
            const plasterCementFactor = parseFloat(document.getElementById('plasterCementFactor').value);
            if (includePlaster) {
                const plasterThickness = parseFloat(document.getElementById('plasterThickness').value) / 1000;
                const plasterVolume = netWallArea * plasterSides * plasterThickness;
                const plasterRatio = document.getElementById('plasterRatio').value;
                const [pCementPart, pSandPart] = plasterRatio.split(':').map(Number);
                const pTotalParts = pCementPart + pSandPart;
                plasterCementBags = Math.ceil(plasterVolume * (pCementPart / pTotalParts) * plasterCementFactor);
                plasterSand = plasterVolume * (pSandPart / pTotalParts);
            }
            
            let productivityRateValue;
            if (document.getElementById('productivityRate').value === 'custom') {
                productivityRateValue = parseFloat(document.getElementById('customRate').value);
            } else {
                productivityRateValue = parseFloat(document.getElementById('productivityRate').value);
            }
            const weatherFactor = parseFloat(document.getElementById('weatherFactor').value) / 100;
            const crewSkill = parseFloat(document.getElementById('crewSkill').value) / 100;
            const siteAccess = parseFloat(document.getElementById('siteAccess').value) / 100;
            const complexityFactor = parseFloat(document.getElementById('complexityFactor').value);
            const scaffoldingFactor = parseFloat(document.getElementById('scaffoldingFactor').value);
            const openingFactor = parseFloat(document.getElementById('openingFactor').value);
            const adjustedProductivity = productivityRateValue * weatherFactor * crewSkill * siteAccess * complexityFactor * scaffoldingFactor * openingFactor;
            const laborDays = netWallArea / adjustedProductivity;
            const masons = parseInt(document.getElementById('masons').value);
            const helpers = parseInt(document.getElementById('helpers').value);
            const carpenters = parseInt(document.getElementById('carpenters').value);
            const chbCost = parseFloat(document.getElementById('chbCost').value);
            const cementCost = parseFloat(document.getElementById('cementCost').value);
            const sandCost = parseFloat(document.getElementById('sandCost').value);
            const rebarCostPerKg = parseFloat(document.getElementById('rebarCost').value);
            const masonDailyRate = parseFloat(document.getElementById('masonDailyRate').value);
            const helperDailyRate = parseFloat(document.getElementById('helperDailyRate').value);
            const carpenterDailyRate = parseFloat(document.getElementById('carpenterDailyRate').value);
            const totalChbCost = chbQuantity * chbCost;
            const totalCementCost = (cementBagsMortar + plasterCementBags) * cementCost;
        const totalSandCost = (sandMortar + plasterSand) * sandCost;
        const totalRebarCost = rebarWeight * rebarCostPerKg;
        const masonCost = masons * laborDays * masonDailyRate;
        const helperCost = helpers * laborDays * helperDailyRate;
        const carpenterCost = carpenters * laborDays * carpenterDailyRate;
        const directCost = totalChbCost + totalCementCost + totalSandCost + totalRebarCost + masonCost + helperCost + carpenterCost;
        const wasteFactor = parseFloat(document.getElementById('wasteFactor').value) / 100;
        const adjustedDirectCost = directCost * (1 + wasteFactor);
        const overhead = parseFloat(document.getElementById('overhead').value) / 100;
        const overheadCost = adjustedDirectCost * overhead;
        const profitMargin = parseFloat(document.getElementById('profitMargin').value) / 100;
        const profitCost = adjustedDirectCost * profitMargin;
        const totalCost = adjustedDirectCost + overheadCost + profitCost;

        // Display Results
        const resultsHtml = `
            <div class="cost-summary">
                <div class="cost-item"><span>Gross Wall Area:</span><span>${grossWallArea.toFixed(2)} m²</span></div>
                <div class="cost-item"><span>Net Wall Area:</span><span>${netWallArea.toFixed(2)} m²</span></div>
                <div class="cost-item"><span>CHB Quantity:</span><span>${chbQuantity} pieces</span></div>
                <div class="cost-item"><span>Mortar Volume:</span><span>${mortarVolume.toFixed(2)} m³</span></div>
                <div class="cost-item"><span>Cement (Mortar):</span><span>${cementBagsMortar} bags</span></div>
                <div class="cost-item"><span>Sand (Mortar):</span><span>${sandMortar.toFixed(2)} m³</span></div>
                ${includePlaster ? `
                    <div class="cost-item"><span>Cement (Plaster):</span><span>${plasterCementBags} bags</span></div>
                    <div class="cost-item"><span>Sand (Plaster):</span><span>${plasterSand.toFixed(2)} m³</span></div>
                ` : ''}
                <div class="cost-item"><span>Rebar Weight:</span><span>${rebarWeight.toFixed(2)} kg</span></div>
                <div class="cost-item"><span>Labor Days:</span><span>${laborDays.toFixed(2)} days</span></div>
                <div class="cost-item"><span>Direct Cost:</span><span>₱${directCost.toFixed(2)}</span></div>
                <div class="cost-item"><span>Adjusted Direct Cost (with Waste):</span><span>₱${adjustedDirectCost.toFixed(2)}</span></div>
                <div class="cost-item"><span>Overhead:</span><span>₱${overheadCost.toFixed(2)}</span></div>
                <div class="cost-item"><span>Profit:</span><span>₱${profitCost.toFixed(2)}</span></div>
                <div class="cost-total"><span>Total Cost:</span><span>₱${totalCost.toFixed(2)}</span></div>
            </div>
        `;
        document.getElementById('results').innerHTML = resultsHtml;

        // Generate BOQ
        const boqHtml = `
            <table id="boqTable" class="boq-table">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Scope of Work</th>
                        <th>Qty</th>
                        <th>Unit</th>
                        <th>Unit Cost</th>
                        <th>Cost</th>
                        <th>Total Cost</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td>Materials - CHB Blocks</td>
                        <td>${chbQuantity}</td>
                        <td>pieces</td>
                        <td>₱${chbCost.toFixed(2)}</td>
                        <td>₱${totalChbCost.toFixed(2)}</td>
                        <td>₱${totalChbCost.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>Materials - Cement (Mortar)</td>
                        <td>${cementBagsMortar}</td>
                        <td>bags</td>
                        <td>₱${cementCost.toFixed(2)}</td>
                        <td>₱${(cementBagsMortar * cementCost).toFixed(2)}</td>
                        <td>₱${(cementBagsMortar * cementCost).toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>Materials - Sand (Mortar)</td>
                        <td>${sandMortar.toFixed(2)}</td>
                        <td>m³</td>
                        <td>₱${sandCost.toFixed(2)}</td>
                        <td>₱${(sandMortar * sandCost).toFixed(2)}</td>
                        <td>₱${(sandMortar * sandCost).toFixed(2)}</td>
                    </tr>
                    ${includePlaster ? `
                        <tr>
                            <td>4</td>
                            <td>Materials - Cement (Plaster)</td>
                            <td>${plasterCementBags}</td>
                            <td>bags</td>
                            <td>₱${cementCost.toFixed(2)}</td>
                            <td>₱${(plasterCementBags * cementCost).toFixed(2)}</td>
                            <td>₱${(plasterCementBags * cementCost).toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td>Materials - Sand (Plaster)</td>
                            <td>${plasterSand.toFixed(2)}</td>
                            <td>m³</td>
                            <td>₱${sandCost.toFixed(2)}</td>
                            <td>₱${(plasterSand * sandCost).toFixed(2)}</td>
                            <td>₱${(plasterSand * sandCost).toFixed(2)}</td>
                        </tr>
                    ` : `
                        <tr><td colspan="7"></td></tr>
                        <tr><td colspan="7"></td></tr>
                    `}
                    <tr>
                        <td>6</td>
                        <td>Materials - Rebar</td>
                        <td>${rebarWeight.toFixed(2)}</td>
                        <td>kg</td>
                        <td>₱${rebarCostPerKg.toFixed(2)}</td>
                        <td>₱${totalRebarCost.toFixed(2)}</td>
                        <td>₱${totalRebarCost.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td colspan="7" style="font-weight: bold; background-color: #f0f0f0;">Materials Total</td>
                        <td>₱${(totalChbCost + totalCementCost + totalSandCost + totalRebarCost).toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>7</td>
                        <td>Labor - Masons</td>
                        <td>${(masons * laborDays).toFixed(2)}</td>
                        <td>days</td>
                        <td>₱${masonDailyRate.toFixed(2)}</td>
                        <td>₱${masonCost.toFixed(2)}</td>
                        <td>₱${masonCost.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>8</td>
                        <td>Labor - Helpers</td>
                        <td>${(helpers * laborDays).toFixed(2)}</td>
                        <td>days</td>
                        <td>₱${helperDailyRate.toFixed(2)}</td>
                        <td>₱${helperCost.toFixed(2)}</td>
                        <td>₱${helperCost.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>9</td>
                        <td>Labor - Carpenters</td>
                        <td>${(carpenters * laborDays).toFixed(2)}</td>
                        <td>days</td>
                        <td>₱${carpenterDailyRate.toFixed(2)}</td>
                        <td>₱${carpenterCost.toFixed(2)}</td>
                        <td>₱${carpenterCost.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td colspan="7" style="font-weight: bold; background-color: #f0f0f0;">Labor Total</td>
                        <td>₱${(masonCost + helperCost + carpenterCost).toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td colspan="7" style="font-weight: bold; background-color: #f0f0f0;">Direct Cost</td>
                        <td>₱${directCost.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td colspan="6"></td>
                        <td>Overhead</td>
                        <td>₱${overheadCost.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td colspan="6"></td>
                        <td>Profit</td>
                        <td>₱${profitCost.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td colspan="7" style="font-weight: bold; background-color: #f0f0f0;">Grand Total</td>
                        <td>₱${totalCost.toFixed(2)}</td>
                    </tr>
                </tbody>
            </table>
        `;
        document.getElementById('boq').innerHTML = boqHtml;

        // Draw Visualization
        drawWallVisualization();
    }

    function drawWallVisualization() {
        if (!canvas || !ctx) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        ctx.scale(zoomLevel, zoomLevel);
        
        const wallLength = parseFloat(document.getElementById('wallLength').value) || 10;
        const wallHeight = parseFloat(document.getElementById('wallHeight').value) || 3;
        const chbSize = parseFloat(document.getElementById('chbSize').value) || 0.15;
        const doorCount = parseInt(document.getElementById('doorCount').value) || 0;
        const doorWidth = parseFloat(document.getElementById('doorWidth').value) || 0.9;
        const doorHeight = parseFloat(document.getElementById('doorHeight').value) || 2.1;
        const windowCount = parseInt(document.getElementById('windowCount').value) || 0;
        const windowWidth = parseFloat(document.getElementById('windowWidth').value) || 1.2;
        const windowHeight = parseFloat(document.getElementById('windowHeight').value) || 1.2;
        
        const scaleX = (canvas.width / (2 * zoomLevel)) / wallLength;
        const scaleY = (canvas.height / (2 * zoomLevel)) / wallHeight;
        const scale = Math.min(scaleX, scaleY);
        
        const centerX = canvas.width / (2 * zoomLevel);
        const centerY = canvas.height / (2 * zoomLevel);
        
        // Draw wall
        ctx.fillStyle = '#f9f9f9';
        ctx.fillRect(centerX - (wallLength * scale) / 2, centerY - (wallHeight * scale) / 2, wallLength * scale, wallHeight * scale);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 1 / zoomLevel;
        ctx.strokeRect(centerX - (wallLength * scale) / 2, centerY - (wallHeight * scale) / 2, wallLength * scale, wallHeight * scale);
        
        // Draw doors
        ctx.fillStyle = 'rgba(200, 200, 255, 0.5)';
        for (let i = 0; i < doorCount; i++) {
            const doorX = centerX - (wallLength * scale) / 2 + (i * wallLength * scale / (doorCount + 1));
            ctx.fillRect(doorX - (doorWidth * scale) / 2, centerY + (wallHeight * scale) / 4, doorWidth * scale, doorHeight * scale);
            ctx.strokeRect(doorX - (doorWidth * scale) / 2, centerY + (wallHeight * scale) / 4, doorWidth * scale, doorHeight * scale);
        }
        
        // Draw windows
        for (let i = 0; i < windowCount; i++) {
            const windowX = centerX - (wallLength * scale) / 2 + (i * wallLength * scale / (windowCount + 1));
            ctx.fillRect(windowX - (windowWidth * scale) / 2, centerY - (wallHeight * scale) / 4, windowWidth * scale, windowHeight * scale);
            ctx.strokeRect(windowX - (windowWidth * scale) / 2, centerY - (wallHeight * scale) / 4, windowWidth * scale, windowHeight * scale);
        }
        
        // Draw rebar (simplified vertical lines)
        const verticalSpacing = parseFloat(document.getElementById('rebarVertSpacing').value) / 1000;
        ctx.strokeStyle = 'red';
        for (let x = centerX - (wallLength * scale) / 2; x <= centerX + (wallLength * scale) / 2; x += verticalSpacing * scale) {
            ctx.beginPath();
            ctx.moveTo(x, centerY - (wallHeight * scale) / 2);
            ctx.lineTo(x, centerY + (wallHeight * scale) / 2);
            ctx.stroke();
        }
        
        ctx.restore();
    }

    function downloadPDF() {
        try {
            const doc = new jsPDF("p", "mm", "a4");

            // Header with project info
            doc.setFontSize(16);
            doc.setFont(undefined, "bold");
            doc.text("Bill of Quantities", 105, 20, { align: "center" });

            doc.setFontSize(10);
            doc.setFont(undefined, "normal");
            doc.text(`Project Name: ${document.getElementById("projectName")?.value || "N/A"}`, 20, 30);
            doc.text(`Project Location: ${document.getElementById("projectLocation")?.value || "N/A"}`, 20, 35);
            doc.text(`Client: ${document.getElementById("clientName")?.value || "N/A"}`, 20, 40);
            doc.text(`Company: ${document.getElementById("companyName")?.value || "N/A"}`, 20, 45);
            doc.text(`Date: ${new Date().toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" })}`, 20, 50);
            doc.text(`Prepared By: ${document.getElementById("preparedBy")?.value || "Estimator"}`, 20, 55);

            // BOQ Table Data
            const boqTable = document.getElementById("boqTable");
            const tableRows = [];
            const columnHeaders = ["Item", "Scope of Work", "Qty", "Unit", "Unit Cost", "Cost", "Total Cost"];

            if (boqTable) {
                const rows = boqTable.querySelectorAll("tbody tr");
                let itemNumber = 1;

                rows.forEach(row => {
                    const cells = row.querySelectorAll("td");
                    if (cells.length >= 5) {
                        const description = cells[1].textContent.trim();
                        const qty = cells[2].textContent.trim();
                        const unit = cells[3].textContent.trim();
                        const unitCost = cells[4].textContent.replace("₱", "").trim() || "0";
                        const totalCost = cells[6].textContent.replace("₱", "").trim() || "0";

                        if (description.includes("Materials") || description.includes("Labor") || description.includes("Direct Cost") || description.includes("Grand Total")) {
                            tableRows.push([{ content: description, colSpan: 7, styles: { fontStyle: "bold", fillColor: [240, 240, 240] } }]);
                        } else if (description.includes("Overhead") || description.includes("Profit")) {
                            tableRows.push(["", description, "", "", "", "", `₱${totalCost}`]);
                        } else if (description === "") {
                            tableRows.push(["", "", "", "", "", "", ""]);
                        } else {
                            const cost = parseFloat(unitCost) * parseFloat(qty.replace(/[^0-9.]/g, "")) || 0;
                            tableRows.push([itemNumber++, description, qty, unit, `₱${unitCost}`, `₱${cost.toFixed(2)}`, `₱${totalCost}`]);
                        }
                    }
                });

                while (tableRows.length < 12) { // Ensure at least 4 items + 2 empty + totals + overhead/profit
                    tableRows.push(["", "", "", "", "", "", ""]);
                }
            }

            // Generate BOQ Table
            doc.autoTable({
                head: [columnHeaders],
                body: tableRows,
                startY: 65,
                theme: "grid",
                headStyles: { fillColor: [200, 200, 200], textColor: [0, 0, 0], fontStyle: "bold" },
                styles: { fontSize: 9, cellPadding: 2, halign: "right", valign: "middle" },
                columnStyles: {
                    0: { cellWidth: 10, halign: "center" },
                    1: { cellWidth: 40 },
                    2: { cellWidth: 15 },
                    3: { cellWidth: 15 },
                    4: { cellWidth: 20 },
                    5: { cellWidth: 20 },
                    6: { cellWidth: 25 }
                }
            });

            // Labor Requirements Table
            const laborY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(12);
            doc.setFont(undefined, "bold");
            doc.text("Labor Requirements", 20, laborY);

            const laborData = [
                ["Description", "Qty", "Unit"],
                ["Mason", document.getElementById("masons").value, "Labor"],
                ["Helper", document.getElementById("helpers").value, "Labor"],
                ["Carpenter", document.getElementById("carpenters").value, "Labor"],
                ["Duration", Math.ceil(laborDays).toString(), "days"]
            ];

            doc.autoTable({
                head: [laborData[0]],
                body: laborData.slice(1),
                startY: laborY + 5,
                theme: "grid",
                headStyles: { fillColor: [200, 200, 200], textColor: [0, 0, 0], fontStyle: "bold" },
                styles: { fontSize: 10, cellPadding: 3, halign: "right" },
                columnStyles: { 0: { cellWidth: 40 }, 1: { cellWidth: 20 }, 2: { cellWidth: 20 } }
            });

            // Footer
            doc.setFontSize(8);
            doc.text("Generated by CHB Wall Calculator - xAI Grok 3", 105, 290, { align: "center" });

            // Save the PDF
            doc.save(`CHB_Wall_BOQ_${document.getElementById("projectName")?.value.replace(/ /g, "_")}_${new Date().toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" })}.pdf`);
        } catch (error) {
            console.error("PDF Generation Error:", error);
            alert("Error generating PDF. Check console for details.");
        }
    }
    </script>
</body>
</html>
